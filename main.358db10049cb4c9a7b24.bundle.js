(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{154:function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function step(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=(t=_.trys).length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}},__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var lodash_get_1=__importDefault(__webpack_require__(149)),lodash_set_1=__importDefault(__webpack_require__(320)),short_uuid_1=__importDefault(__webpack_require__(155)),helpers_1=__webpack_require__(89),types_1=__webpack_require__(90);function createRPC(_callName,_connectionID,target,listeners){return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];return new Promise(function(resolve,reject){var callID=short_uuid_1.default.generate();function handleResponse(event){var _a=event.data,callID=_a.callID,connectionID=_a.connectionID,callName=_a.callName,result=_a.result,error=_a.error,action=_a.action;if(helpers_1.isTrustedRemote(event)&&callID&&callName&&callName===_callName&&connectionID===_connectionID)return action===types_1.actions.RPC_RESOLVE?resolve(result):action===types_1.actions.RPC_REJECT?reject(error):void 0}var payload={action:types_1.actions.RPC_REQUEST,args:args,callID:callID,callName:_callName,connectionID:_connectionID};window.addEventListener(types_1.events.MESSAGE,handleResponse),listeners.push(function(){return window.removeEventListener(types_1.events.MESSAGE,handleResponse)}),target.postMessage(payload,target.origin)})}}exports.registerLocalMethods=function registerLocalMethods(schema,methods,_connectionID){var listeners=[];return methods.forEach(function(methodName){function handleCall(event){return __awaiter(this,void 0,void 0,function(){var _a,action,callID,connectionID,callName,args,result,error_1;return __generator(this,function(_b){switch(_b.label){case 0:if(_a=event.data,action=_a.action,callID=_a.callID,connectionID=_a.connectionID,callName=_a.callName,args=_a.args,action!==types_1.actions.RPC_REQUEST)return[2];if(!helpers_1.isTrustedRemote(event))return[2];if(!callID||!callName)return[2];if(callName!==methodName)return[2];if(connectionID!==_connectionID)return[2];_b.label=1;case 1:return _b.trys.push([1,3,,4]),[4,lodash_get_1.default(schema,methodName).apply(void 0,args)];case 2:return result=_b.sent(),event.source.postMessage({action:types_1.actions.RPC_RESOLVE,callID:callID,callName:callName,connectionID:connectionID,result:result}),[3,4];case 3:return error_1=_b.sent(),event.source.postMessage({action:types_1.actions.RPC_REJECT,callID:callID,callName:callName,connectionID:connectionID,error:error_1}),[3,4];case 4:return[2]}})})}window.addEventListener(types_1.events.MESSAGE,handleCall),listeners.push(function(){return window.removeEventListener(types_1.events.MESSAGE,handleCall)})}),function(){return listeners.forEach(function(unregister){return unregister()})}},exports.registerRemoteMethods=function registerRemoteMethods(schema,methods,_connectionID,target){var remote=Object.assign({},schema),listeners=[];return methods.forEach(function(methodName){var rpc=createRPC(methodName,_connectionID,target,listeners);lodash_set_1.default(remote,methodName,rpc)}),{remote:remote,unregisterRemote:function(){return listeners.forEach(function(unregister){return unregister()})}}},exports.createRPC=createRPC},157:function(module,exports,__webpack_require__){__webpack_require__(158),__webpack_require__(235),module.exports=__webpack_require__(236)},236:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),function(module){__webpack_require__(30),__webpack_require__(31),__webpack_require__(29),__webpack_require__(53);var _storybook_react__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(59),req=__webpack_require__(310);Object(_storybook_react__WEBPACK_IMPORTED_MODULE_4__.configure)(function loadStories(){req.keys().forEach(function(filename){return req(filename)})},module)}.call(this,__webpack_require__(116)(module))},310:function(module,exports,__webpack_require__){var map={"./index.stories.js":311};function webpackContext(req){var id=webpackContextResolve(req);return __webpack_require__(id)}function webpackContextResolve(req){if(!__webpack_require__.o(map,req)){var e=new Error("Cannot find module '"+req+"'");throw e.code="MODULE_NOT_FOUND",e}return map[req]}webpackContext.keys=function webpackContextKeys(){return Object.keys(map)},webpackContext.resolve=webpackContextResolve,module.exports=webpackContext,webpackContext.id=310},311:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),function(module){__webpack_require__(312),__webpack_require__(44),__webpack_require__(36),__webpack_require__(55),__webpack_require__(30),__webpack_require__(31),__webpack_require__(29),__webpack_require__(79),__webpack_require__(318);var react__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(1),react__WEBPACK_IMPORTED_MODULE_9___default=__webpack_require__.n(react__WEBPACK_IMPORTED_MODULE_9__),_storybook_react__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(59),_index__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(91),raw_loader_index_html__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(92),raw_loader_index_html__WEBPACK_IMPORTED_MODULE_12___default=__webpack_require__.n(raw_loader_index_html__WEBPACK_IMPORTED_MODULE_12__);function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _slicedToArray(arr,i){return function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function _iterableToArrayLimit(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var _ref=react__WEBPACK_IMPORTED_MODULE_9___default.a.createElement("h1",null,"HOST");function Demo(){var iframe1=react__WEBPACK_IMPORTED_MODULE_9___default.a.useRef(null),iframe2=react__WEBPACK_IMPORTED_MODULE_9___default.a.useRef(null),_React$useState2=_slicedToArray(react__WEBPACK_IMPORTED_MODULE_9___default.a.useState(""),2),message=_React$useState2[0],setMessage=_React$useState2[1],_React$useState4=_slicedToArray(react__WEBPACK_IMPORTED_MODULE_9___default.a.useState({}),2),childSchema=_React$useState4[0],setChildSchema=_React$useState4[1],_React$useState6=_slicedToArray(react__WEBPACK_IMPORTED_MODULE_9___default.a.useState(""),2),childMessage=_React$useState6[0],setChildMessage=_React$useState6[1];return react__WEBPACK_IMPORTED_MODULE_9___default.a.useEffect(function(){function _run(){return(_run=function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}var gen=fn.apply(self,args);_next(void 0)})}}(regeneratorRuntime.mark(function _callee(){var connection;return regeneratorRuntime.wrap(function(_context){for(;;)switch(_context.prev=_context.next){case 0:return _context.next=2,_index__WEBPACK_IMPORTED_MODULE_11__.host.connect(iframe1.current,{sendMessage:function(message){setChildMessage(message)}});case 2:connection=_context.sent,_index__WEBPACK_IMPORTED_MODULE_11__.host.connect(iframe2.current,{sendMessage:function sendMessage(message){setChildMessage(message)}}),setChildSchema(connection.remote);case 5:case"end":return _context.stop()}},_callee)}))).apply(this,arguments)}!function run(){return _run.apply(this,arguments)}()},[]),react__WEBPACK_IMPORTED_MODULE_9___default.a.createElement("div",null,_ref,react__WEBPACK_IMPORTED_MODULE_9___default.a.createElement("div",null,"child message: ",childMessage),react__WEBPACK_IMPORTED_MODULE_9___default.a.createElement("div",null,"child schema:  ",Object.keys(childSchema).join(";")),react__WEBPACK_IMPORTED_MODULE_9___default.a.createElement("input",{value:message,onChange:function onChange(e){return setMessage(e.target.value)}}),react__WEBPACK_IMPORTED_MODULE_9___default.a.createElement("button",{onClick:function onClick(){return childSchema.sendMessage(message)}},"call guest"),react__WEBPACK_IMPORTED_MODULE_9___default.a.createElement("iframe",{style:{border:"1px solid #e2e2e2",height:"250px",width:"100%"},title:"child",ref:iframe1,srcDoc:raw_loader_index_html__WEBPACK_IMPORTED_MODULE_12___default.a,sandbox:"allow-same-origin allow-scripts"}),react__WEBPACK_IMPORTED_MODULE_9___default.a.createElement("iframe",{style:{border:"1px solid #e2e2e2",height:"250px",width:"100%"},title:"child",ref:iframe2,srcDoc:raw_loader_index_html__WEBPACK_IMPORTED_MODULE_12___default.a,sandbox:"allow-same-origin allow-scripts"}))}Demo.displayName="Demo";var _ref2=react__WEBPACK_IMPORTED_MODULE_9___default.a.createElement(Demo,null);Object(_storybook_react__WEBPACK_IMPORTED_MODULE_10__.storiesOf)("rimless",module).add("communication",function(){return _ref2})}.call(this,__webpack_require__(116)(module))},319:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var helpers_1=__webpack_require__(89),rpc_1=__webpack_require__(154),types_1=__webpack_require__(90);exports.default={connect:function connect(schema,options){return new Promise(function(resolve,reject){var localMethods=helpers_1.extractMethods(schema);window.addEventListener(types_1.events.MESSAGE,function handleHandshakeResponse(event){if(event.data.action===types_1.actions.HANDSHAKE_REPLY){var unregisterLocal=rpc_1.registerLocalMethods(schema,localMethods,event.data.connectionID),_a=rpc_1.registerRemoteMethods(event.data.schema,event.data.methods,event.data.connectionID,event.source),remote=_a.remote,unregisterRemote=_a.unregisterRemote;return resolve({remote:remote,close:function(){window.removeEventListener(types_1.events.MESSAGE,handleHandshakeResponse),unregisterRemote(),unregisterLocal()}})}}),window.parent.postMessage({action:types_1.actions.HANDSHAKE_REQUEST,methods:localMethods,schema:JSON.parse(JSON.stringify(schema))},"*")})}}},326:function(module,exports,__webpack_require__){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var short_uuid_1=__importDefault(__webpack_require__(155)),helpers_1=__webpack_require__(89),rpc_1=__webpack_require__(154),types_1=__webpack_require__(90),connections={};exports.default={connect:function connect(iframe,schema,options){if(!iframe)throw new Error("a target iframe is required");return new Promise(function(resolve,reject){var connectionID=short_uuid_1.default.generate();window.addEventListener(types_1.events.MESSAGE,function handleHandshake(event){if(function isValidTarget(iframe,event){var childURL=iframe.getAttribute("src"),childOrigin=helpers_1.getOriginFromURL(childURL),hasProperOrigin=event.origin===childOrigin,hasProperSource=event.source===iframe.contentWindow;return hasProperOrigin&&hasProperSource}(iframe,event)&&event.data.action===types_1.actions.HANDSHAKE_REQUEST){var localMethods=helpers_1.extractMethods(schema),unregisterLocal=rpc_1.registerLocalMethods(schema,localMethods,connectionID),_a=rpc_1.registerRemoteMethods(event.data.schema,event.data.methods,connectionID,event.source),remote=_a.remote,unregisterRemote=_a.unregisterRemote;event.source.postMessage({action:types_1.actions.HANDSHAKE_REPLY,connectionID:connectionID,methods:localMethods,schema:JSON.parse(JSON.stringify(schema))},event.origin);var connection={remote:remote,close:function(){window.removeEventListener(types_1.events.MESSAGE,handleHandshake),unregisterRemote(),unregisterLocal()}};return connections[connectionID]=connection,resolve(connection)}})})}}},89:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CONNECTION_TIMEOUT=1e3,exports.isTrustedRemote=function isTrustedRemote(event){return!0},exports.extractMethods=function extractMethods(obj){var paths=[];return function parse(obj,path){for(var prop in void 0===path&&(path=""),obj){var propPath=path?path+"."+prop:prop;obj[prop]===Object(obj[prop])&&parse(obj[prop],propPath),"function"==typeof obj[prop]&&paths.push(propPath)}}(obj),paths};var urlRegex=/^(https?:|file:)?\/\/([^\/:]+)?(:(\d+))?/,ports={"http:":"80","https:":"443"};exports.getOriginFromURL=function getOriginFromURL(url){var protocol,hostname,port,location=document.location,regexResult=urlRegex.exec(url||"");return regexResult?(protocol=regexResult[1]?regexResult[1]:location.protocol,hostname=regexResult[2],port=regexResult[4]):(protocol=location.protocol,hostname=location.hostname,port=location.port),"file:"===protocol?"null":protocol+"//"+hostname+(port&&port!==ports[protocol]?":"+port:"")}},90:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),function(events){events.MESSAGE="message"}(exports.events||(exports.events={})),function(actions){actions.HANDSHAKE_REQUEST="RIMLESS/HANDSHAKE_REQUEST",actions.HANDSHAKE_REPLY="RIMLESS/HANDSHAKE_REPLY",actions.RPC_REQUEST="RIMLESS/RPC_REQUEST",actions.RPC_RESOLVE="RIMLESS/RPC_RESOLVE",actions.RPC_REJECT="RIMLESS/RPC_REJECT"}(exports.actions||(exports.actions={}))},91:function(module,exports,__webpack_require__){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var guest_1=__importDefault(__webpack_require__(319));exports.guest=guest_1.default;var host_1=__importDefault(__webpack_require__(326));exports.host=host_1.default},92:function(module,exports){module.exports='<!DOCTYPE html>\n<html>\n\n<head>\n  <meta charset="utf-8">\n  <meta http-equiv="X-UA-Compatible" content="IE=edge">\n  <title>guest page</title>\n  <meta name="viewport" content="width=device-width, initial-scale=1">\n  <script src="https://unpkg.com/rimless@0.0.4/lib/rimless.min.js"><\/script>\n  <style>\n    html,\n    body {\n      margin: 0;\n      padding: 0;\n      height: 100%;\n      width: 100%;\n      font-family: sans-serif;\n    }\n\n    .content {\n      padding: 1rem;\n    }\n\n    .item {\n      margin-bottom: 1rem;\n    }\n\n    .connection {\n      position: absolute;\n      top: .5rem;\n      left: .5rem;\n      border-radius: 24px;\n      height: 8px;\n      width: 8px;\n      background: red;\n    }\n\n    .connection.connected {\n      background: green;\n    }\n  </style>\n</head>\n\n<body>\n  <div class="content">\n    <h1>GUEST <span></span></h1>\n    <div id="connection" class="connection"></div>\n\n    <div class="item">\n      host message: <span id="message"></span>\n    </div>\n\n    <div class="item">\n      host schema: <span id="schema"></span>\n    </div>\n\n    <input id="msg" placeholder="message for parent"></input>\n    <button id="btn">call host</button>\n  </div>\n\n  <script>\n    const { guest } = rimless;\n\n    async function connect() {\n\n      // returns the host object with the API defined by the host\n      const connection = await guest.connect({\n        foo: "foo",\n        bar: 1,\n        sendMessage: (message) => {\n          console.log("GUEST has been called", message)\n          document.getElementById("message").innerHTML = message\n        },\n      });\n\n      document.getElementById("connection").className += " connected"\n      document.getElementById("schema").innerHTML = Object.keys(connection.remote).join(";");\n\n      document.getElementById("btn").onclick = async function () {\n        connection.remote.sendMessage(document.getElementById("msg").value);\n      }\n    }\n\n    connect();\n  <\/script>\n</body>\n\n</html>'}},[[157,1,2]]]);
//# sourceMappingURL=main.358db10049cb4c9a7b24.bundle.js.map